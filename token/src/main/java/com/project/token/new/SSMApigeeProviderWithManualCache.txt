package com.project.token.provider;

import com.project.token.transformer.ApigeeBearerTransformer;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import software.amazon.awssdk.core.SdkSystemSetting;
import software.amazon.awssdk.core.client.config.ClientOverrideConfiguration;
import software.amazon.awssdk.core.client.config.SdkAdvancedClientOption;
import software.amazon.awssdk.http.urlconnection.UrlConnectionHttpClient;
import software.amazon.awssdk.regions.Region;
import software.amazon.awssdk.services.secretsmanager.SecretsManagerClient;
import software.amazon.awssdk.services.secretsmanager.model.GetSecretValueRequest;

import java.nio.charset.StandardCharsets;
import java.util.Base64;
import java.util.Optional;
import java.util.concurrent.ConcurrentHashMap;

public class SSMApigeeProvider {

    private static final Logger LOG = LoggerFactory.getLogger(SSMApigeeProvider.class);
    public static final String TOKEN_SECRET_NAME = getRequiredEnv("TOKEN_SECRET_NAME");

    private static final long CACHE_TTL_MILLIS = 3300 * 1000L; // 55 minutes in milliseconds

    private final SecretsManagerClient client;
    private final ApigeeBearerTransformer transformer;

    // Token cache: key = secret name, value = CachedToken
    private static final ConcurrentHashMap<String, CachedToken> tokenCache = new ConcurrentHashMap<>();

    private SSMApigeeProvider(Builder builder) {
        this.client = builder.client != null ? builder.client : createDefaultClient();
        this.transformer = builder.transformer != null ? builder.transformer : new ApigeeBearerTransformer();
        LOG.info("SSMApigeeProvider initialized with token caching enabled (TTL: {} seconds / {} minutes)",
                CACHE_TTL_MILLIS / 1000, CACHE_TTL_MILLIS / 60000);
    }

    public static Builder builder() {
        return new Builder();
    }

    public static SSMApigeeProvider get() {
        return builder().build();
    }

    private static SecretsManagerClient createDefaultClient() {
        return SecretsManagerClient.builder()
                .httpClientBuilder(UrlConnectionHttpClient.builder())
                .region(Region.of(
                        System.getenv().getOrDefault(
                                SdkSystemSetting.AWS_REGION.environmentVariable(),
                                "us-east-1"
                        )))
                .overrideConfiguration(ClientOverrideConfiguration.builder()
                        .putAdvancedOption(
                                SdkAdvancedClientOption.USER_AGENT_SUFFIX,
                                "powertools-parameters")
                        .build())
                .build();
    }

    // Helper to require env vars at startup (keeps behavior explicit and fails fast)
    private static String getRequiredEnv(String name) {
        String val = System.getenv(name);
        if (val == null || val.trim().isEmpty()) {
            throw new IllegalStateException("Required environment variable '" + name + "' is not set.");
        }
        return val;
    }

    /**
     * Get OAuth2 bearer token with automatic caching.
     *
     * @param secretKey Secret name (uses TOKEN_SECRET_NAME if null)
     * @return Cached or fresh OAuth2 bearer token
     */
    public String getValue(String secretKey) {
        String key = (secretKey == null || secretKey.trim().isEmpty()) ? TOKEN_SECRET_NAME : secretKey;

        long startTime = System.currentTimeMillis();

        // Check cache first
        CachedToken cachedToken = tokenCache.get(key);
        if (cachedToken != null && !cachedToken.isExpired()) {
            long cacheAge = System.currentTimeMillis() - cachedToken.cachedAt;
            long remainingTTL = (CACHE_TTL_MILLIS - cacheAge) / 1000;
            LOG.info("OAuth2 bearer token retrieved from CACHE (age: {} seconds, remaining TTL: {} seconds)",
                    cacheAge / 1000, remainingTTL);
            return cachedToken.token;
        }

        // Cache miss or expired - fetch fresh token
        if (cachedToken != null) {
            LOG.info("Cached token expired, fetching fresh token from OAuth2 endpoint");
        } else {
            LOG.info("No cached token found, fetching fresh token from OAuth2 endpoint");
        }

        // Fetch credentials from Secrets Manager
        LOG.debug("Fetching OAuth2 credentials from Secrets Manager: {}", key);
        long secretStartTime = System.currentTimeMillis();
        String secretValue = getSecretFromSecretsManager(key);
        long secretsFetchTime = System.currentTimeMillis() - secretStartTime;
        LOG.debug("Secrets Manager fetch completed in {} ms", secretsFetchTime);

        // Call OAuth2 token endpoint to get bearer token
        long tokenStartTime = System.currentTimeMillis();
        String token = transformer.applyTransformation(secretValue, String.class);
        long tokenFetchTime = System.currentTimeMillis() - tokenStartTime;

        // Cache the token
        tokenCache.put(key, new CachedToken(token, System.currentTimeMillis()));

        long totalTime = System.currentTimeMillis() - startTime;
        LOG.info("Fresh OAuth2 token fetched and CACHED - Secrets: {} ms, Token API: {} ms, Total: {} ms",
                secretsFetchTime, tokenFetchTime, totalTime);

        return token;
    }

    /**
     * Reset cache - clears all cached tokens.
     */
    public void resetToDefaults() {
        int cacheSize = tokenCache.size();
        tokenCache.clear();
        LOG.info("Token cache cleared - {} cached token(s) removed", cacheSize);
    }

    private String getSecretFromSecretsManager(String secretKey) {
        GetSecretValueRequest request = GetSecretValueRequest.builder()
                .secretId(secretKey)
                .build();

        return Optional.ofNullable(client.getSecretValue(request).secretString())
                .orElseGet(() -> new String(
                        Base64.getDecoder().decode(
                                client.getSecretValue(request)
                                        .secretBinary()
                                        .asByteArray()
                        ),
                        StandardCharsets.UTF_8
                ));
    }

    /**
     * Cached token with expiration tracking.
     */
    private static class CachedToken {
        final String token;
        final long cachedAt;

        CachedToken(String token, long cachedAt) {
            this.token = token;
            this.cachedAt = cachedAt;
        }

        boolean isExpired() {
            return (System.currentTimeMillis() - cachedAt) > CACHE_TTL_MILLIS;
        }
    }

    public static class Builder {
        private SecretsManagerClient client;

        private ApigeeBearerTransformer transformer;

        private Builder() {
        }

        public Builder withClient(SecretsManagerClient client) {
            this.client = client;
            return this;
        }

        public Builder withTransformer(ApigeeBearerTransformer transformer) {
            this.transformer = transformer;
            return this;
        }

        public SSMApigeeProvider build() {
            return new SSMApigeeProvider(this);
        }
    }

}
