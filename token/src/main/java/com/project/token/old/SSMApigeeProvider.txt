package com.svb.payments.secretsmanager;

import software.amazon.awssdk.core.SdkSystemSetting;
import software.amazon.awssdk.core.client.config.ClientOverrideConfiguration;
import software.amazon.awssdk.core.client.config.SdkAdvancedClientOption;
import software.amazon.awssdk.http.urlconnection.UrlConnectionHttpClient;
import software.amazon.awssdk.regions.Region;
import software.amazon.awssdk.services.secretsmanager.SecretsManagerClient;
import software.amazon.awssdk.services.secretsmanager.model.GetSecretValueRequest;
import software.amazon.lambda.powertools.core.internal.UserAgentConfigurator;
import software.amazon.lambda.powertools.parameters.BaseProvider;
import software.amazon.lambda.powertools.parameters.ParamManager;
import software.amazon.lambda.powertools.parameters.cache.CacheManager;
import software.amazon.lambda.powertools.parameters.transform.TransformationManager;
import software.amazon.lambda.powertools.parameters.transform.Transformer;

import java.nio.charset.StandardCharsets;
import java.time.temporal.ChronoUnit;
import java.util.Base64;
import java.util.Map;
import java.util.Optional;

public class SSMApigeeProvider extends BaseProvider {

    private final SecretsManagerClient client;

    public SSMApigeeProvider() {
        this(ParamManager.getCacheManager());
    }

    public SSMApigeeProvider(CacheManager cacheManager) {
        this(cacheManager,
                SSMApigeeProvider.Builder.createClient(),
                ParamManager.getTransformationManager());
    }

    public SSMApigeeProvider(CacheManager cacheManager,
                             SecretsManagerClient client,
                             TransformationManager transformationManager) {

        super(cacheManager);
        this.client = client;

        super.defaultMaxAge(3600, ChronoUnit.SECONDS);
        super.setTransformationManager(transformationManager);
        super.withTransformation(ApigeeBearerTransformer.class);
    }

    public static Builder builder() {
        return new Builder();
    }

    @Override
    protected String getValue(String key) {
        GetSecretValueRequest request =
                GetSecretValueRequest.builder().secretId(key).build();

        return Optional.ofNullable(client.getSecretValue(request).secretString())
                .orElseGet(() -> new String(
                        Base64.getDecoder().decode(
                                client.getSecretValue(request)
                                        .secretBinary()
                                        .asByteArray()
                        ),
                        StandardCharsets.UTF_8
                ));
    }

    @Override
    protected Map<String, String> getMultipleValues(String path) {
        throw new UnsupportedOperationException(
                "Impossible to get multiple values from AWS Secrets Manager");
    }

    @Override
    protected void resetToDefaults() {
        super.resetToDefaults();
    }

    public static class Builder {

        private SecretsManagerClient client;
        private CacheManager cacheManager;
        private TransformationManager transformationManager;

        private Builder() {
        }

        private static SecretsManagerClient createClient() {
            return SecretsManagerClient.builder()
                    .httpClientBuilder(UrlConnectionHttpClient.builder())
                    .region(Region.of(
                            System.getenv(SdkSystemSetting.AWS_REGION.environmentVariable())))
                    .overrideConfiguration(ClientOverrideConfiguration.builder()
                            .putAdvancedOption(
                                    SdkAdvancedClientOption.USER_AGENT_SUFFIX,
                                    UserAgentConfigurator.getUserAgent("parameters"))
                            .build())
                    .build();
        }

        public SSMApigeeProvider build() {
            if (this.cacheManager == null) {
                throw new IllegalStateException(
                        "No CacheManager provided, please provide one");
            }

            if (this.client == null) {
                this.client = createClient();
            }

            return new SSMApigeeProvider(
                    this.cacheManager,
                    this.client,
                    Optional.ofNullable(this.transformationManager)
                            .orElseGet(ParamManager::getTransformationManager));
        }

        public Builder withClient(SecretsManagerClient client) {
            this.client = client;
            return this;
        }

        public Builder withCacheManager(CacheManager cacheManager) {
            this.cacheManager = cacheManager;
            return this;
        }

        public Builder withTransformationManager(
                TransformationManager transformationManager) {
            this.transformationManager = transformationManager;
            return this;
        }
    }
}
